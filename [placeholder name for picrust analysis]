#installing PICRUSt2 from source (manually)
#Make sure you are in the location that you want to install 

cd data/project_2/
mkdir picrust
cd picrust
 
wget https://github.com/picrust/picrust2/archive/v2.5.2.tar.gz	#This line downloads the PICRUSt2 tool as a compressed file to your current directory
tar xvzf  v2.5.2.tar.gz	# Decompress the file
cd picrust2-2.5.2/	#Enter the picrust2 directory

#Before running the below lines of code, exit the qiime environment if you are in one. 
conda deactivate

conda env create -f picrust2-env.yaml	#create the conda environment with some modifications from the picrust2-env.yaml file. This can take up to 30mins.
conda activate picrust2		#Activate the environment
pip install --editable .	#Install PICRUSt2

pytest		#Run a test with sample data to make sure it is working!
			#If your test passes with 59/60 tests successful, we will ingore the failed test and move forward.




#To Run, we need these files:

									
									#seqs.fna	 (The rep-seqs.qza file)
									#table.biom	 (the table.qza*)

qiime tools export \
	--input-path ~/data/project_2/100_trunc/100-rep-seqs.qza \
	--output-path seqs_export 
	#This is how you can export your rep-seqs.qza to a .fna or .fasta file format

	cd seqs_export
	mv dna-sequences.fasta ..

# filter the table.qza to remove all the features with 5 or lower counts. This will make the PICRUSt2 analysis much faster.

qiime feature-table filter-features \
  --i-table ~/data/project_2/100_trunc/100-table.qza \
  --p-min-frequency 5 \
  --o-filtered-table feature-frequency-filtered-table.qza

qiime tools export \
 --input-path feature-frequency-filtered-table.qza \
 --output-path exported_table_biom

 cd exported_table_biom
 mv feature-table.biom ..
							  				  
							  
#Running PICRUSt2 Analysis!
#First, make sure you are in the picrust2-2.5.2/ folder.

picrust2_pipeline.py -s dna-sequences.fasta -i feature-table.biom -o picrust2_out_pipeline -p 1 	#This will 30-60 mins depending on your dataset.


#To annotate pathways with a useful description (OPTIONAL because there is a command in R to do the same thing)
./add_descriptions.py -i ../../picrust2_out_pipline/output/pathways_out/path_abun_unstrat.tsv.gz -m METACYC -o ../../picrust2_out_pipline/output/pathways_out/path_abun_unstrat_descript.tsv.gz


#For details on what this single line of code is doing, see https://github.com/picrust/picrust2/wiki/PICRUSt2-Tutorial-(v2.5.2)#minimum-requirements-to-run-full-tutorial


#We will use a new package called ggpicrust2 (https://github.com/cafferychen777/ggpicrust2)
#to analysis our data and generate figures.
#Tutorial on this package and how to run can be found here: https://github.com/cafferychen777/ggpicrust2 | This is what I generated by basic tutorial from.

