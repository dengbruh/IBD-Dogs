#### Loading phyloseq, tidyverse, ape, picante, and ggsignif ####
library(phyloseq)
library(ape)
library(tidyverse)
library(picante)
library(ggsignif)


#### Load in RData ####
load("ibd_rare.RData")
load("ibd_final.RData")


#### Creating new column in metadata to compile both species and disease state ####
sample_data(ibd_rare)[[38]] = paste(sample_data(ibd_rare)[[10]],sample_data(ibd_rare)[[15]])


#### Extracting information for statistical tests ####
alphadiv <- estimate_richness(ibd_rare)
samp_dat <- sample_data(ibd_rare)
samp_dat_wdiv <- data.frame(samp_dat, alphadiv)

##############################################################################
#### Alpha diversity - Shannon ######

# Running 2 way anova
shannon_species_disease <- lm(Shannon ~ `V38`, data=samp_dat_wdiv)
summary(aov(shannon_species_disease))
TukeyHSD(aov(shannon_species_disease))

# Creating the initial box plot #
alpha_shannon <- samp_dat_wdiv %>%
  mutate(V38 = fct_relevel(V38, 
                            "Dog Healthy", "Human Healthy", "Dog IBD", 
                            "Human Crohn's Disease", "Human Ulcerative Colitis")) %>%
  ggplot(aes(x=`V38`, y=Shannon, fill = V38)) +
  geom_boxplot() +
  geom_signif(comparisons = list(c("Dog Healthy","Human Healthy"),c("Dog IBD","Human Crohn's Disease"), c("Dog IBD", "Human Ulcerative Colitis")),
              y_position = c(4.2, 4.5, 4.7),
              annotations = c("****","*","****")) +
  ylab("Shannon Diversity") +
  xlab("Species and Disease State")

alpha_shannon <- alpha_shannon + guides(fill=guide_legend(title="Species and Disease State"))

# Save plot
ggsave(filename = "alpha_shannon.png"
       , alpha_shannon
       , height=6, width=10)

##############################################################################
#### Alpha diversity - Observered ######
# Running 2 way anova
observed_species_disease <- lm(Observed ~ `V38`, data=samp_dat_wdiv)
summary(aov(observed_species_disease))
TukeyHSD(aov(observed_species_disease))

# Creating the initial box plot #
alpha_observed <- samp_dat_wdiv %>%
  mutate(V38 = fct_relevel(V38, 
                           "Dog Healthy", "Human Healthy", "Dog IBD", 
                           "Human Crohn's Disease", "Human Ulcerative Colitis")) %>%
  ggplot(aes(x=`V38`, y=Observed, fill = V38)) +
  geom_boxplot() +
  geom_signif(comparisons = list(c("Dog Healthy","Human Healthy"),c("Dog IBD","Human Crohn's Disease"), c("Dog IBD", "Human Ulcerative Colitis")),
              y_position = c(150, 180, 200),
              annotations = c("****","****","****")) +
  ylab("Observed Features") +
  xlab("Species and Disease State")

alpha_observed <- alpha_observed + guides(fill=guide_legend(title="Species and Disease State"))

alpha_observed

# Save plot
ggsave(filename = "alpha_observed.png"
       , alpha_observed
       , height=6, width=10)

##############################################################################
#### Alpha diversity - Faith's PD #####

# Calculate Faith's phylogenetic diversity as PD
phylo_dist <- pd(t(otu_table(ibd_rare)), phy_tree(ibd_rare),
                 include.root=F) 

# Add PD to metadata table
samp_dat_wfaith <- data.frame(samp_dat, phylo_dist)

# Running 2 way anova
faith_species_disease <- lm(PD ~ `V38`, data=samp_dat_wfaith)
summary(aov(faith_species_disease))
TukeyHSD(aov(faith_species_disease))

# Plot any metadata category against the PD
plot.pd <- samp_dat_wfaith %>%
  mutate(V38 = fct_relevel(V38, 
                           "Dog Healthy", "Human Healthy", "Dog IBD", 
                           "Human Crohn's Disease", "Human Ulcerative Colitis")) %>%
  ggplot(aes(x=`V38`, y=`PD`, fill = V38)) +
  geom_boxplot() +
  geom_signif(comparisons = list(c("Dog Healthy","Human Healthy"),c("Dog IBD","Human Crohn's Disease"), c("Dog IBD", "Human Ulcerative Colitis")),
              y_position = c(15, 17, 19),
              annotations = c("****","****","****")) +
  ylab("Faith's Phylogenetic Distance") +
  xlab("Species and Disease State")

plot.pd <- plot.pd + guides(fill=guide_legend(title="Species and Disease State"))

plot.pd

# Save plot
ggsave(filename = "alpha_faith.png"
       , plot.pd
       , height=6, width=10)

##############################################################################
#### Alpha diversity - Simpson ######
# Running 2 way anova
simpson_species_disease <- lm(Simpson ~ `V38`, data=samp_dat_wdiv)
summary(aov(simpson_species_disease))
TukeyHSD(aov(simpson_species_disease))

# Creating the initial box plot #
alpha_simpson <- samp_dat_wdiv %>%
  mutate(V38 = fct_relevel(V38, 
                           "Dog Healthy", "Human Healthy", "Dog IBD", 
                           "Human Crohn's Disease", "Human Ulcerative Colitis")) %>%
  ggplot(aes(x=`V38`, y=Simpson, fill = V38)) +
  geom_boxplot() +
  geom_signif(comparisons = list(c("Dog Healthy","Human Healthy"),c("Dog IBD","Human Crohn's Disease"), c("Dog IBD", "Human Ulcerative Colitis")),
              y_position = c(1, 1.1, 1.2),
              annotations = c("n.s.","n.s.","****")) +
  ylab("Simpson Index") +
  xlab("Species and Disease State")

alpha_simpson <- alpha_simpson + guides(fill=guide_legend(title="Species and Disease State"))

alpha_simpson

# Save plot
ggsave(filename = "alpha_simpson.png"
       , alpha_simpson
       , height=6, width=10)


##############################################################################
#### Alpha diversity - Chao ######
# Running 2 way anova
chao_species_disease <- lm(Chao1 ~ `V38`, data=samp_dat_wdiv)
summary(aov(chao_species_disease))
TukeyHSD(aov(chao_species_disease))

# Creating the initial box plot #
alpha_chao <- alpha_simpson <- samp_dat_wdiv %>%
  mutate(V38 = fct_relevel(V38, 
                           "Dog Healthy", "Human Healthy", "Dog IBD", 
                           "Human Crohn's Disease", "Human Ulcerative Colitis")) %>%
  ggplot(aes(x=`V38`, y=Chao1, fill = V38)) +
  geom_boxplot() +
  geom_signif(comparisons = list(c("Dog Healthy","Human Healthy"),c("Dog IBD","Human Crohn's Disease"), c("Dog IBD", "Human Ulcerative Colitis")),
              y_position = c(145, 155, 165),
              annotations = c("****","****","****")) +
  ylab("Chao Index") +
  xlab("Species and Disease State")

alpha_chao <- alpha_chao + guides(fill=guide_legend(title="Species and Disease State"))

alpha_chao


# Save plot
ggsave(filename = "alpha_chao.png"
       , alpha_chao
       , height=6, width=10)