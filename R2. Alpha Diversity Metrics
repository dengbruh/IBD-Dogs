#### Loading phyloseq, tidyverse, ape, picante, and ggsignif ####
library(phyloseq)
library(ape)
library(tidyverse)
library(picante)
library(ggsignif)


#### Load in RData ####
load("ibd_rare.RData")
load("ibd_final.RData")


#### Creating new column in metadata to compile both species and disease state ####
sample_data(ibd_rare)[[38]] = paste(sample_data(ibd_rare)[[15]],sample_data(ibd_rare)[[10]])


#### Extracting information for statistical tests ####
alphadiv <- estimate_richness(ibd_rare)
samp_dat <- sample_data(ibd_rare)
samp_dat_wdiv <- data.frame(samp_dat, alphadiv)

##############################################################################
#### Alpha diversity - Shannon ######

# Running 2 way anova
shannon_species_disease <- lm(Shannon ~ `V38`, data=samp_dat_wdiv)
summary(aov(shannon_species_disease))
TukeyHSD(aov(shannon_species_disease))

# Creating the initial box plot #
alpha_shannon <- samp_dat_wdiv %>%
  mutate(V38 = fct_relevel(V38, 
                            "Healthy Dog", "Healthy Human", "IBD Dog", 
                            "Crohn's Disease Human", "Ulcerative Colitis Human")) %>%
  ggplot(aes(x=`V38`, y=Shannon, fill = V38)) +
  theme_bw() +
  theme(axis.text.x = element_text(size = 14, angle = -30, hjust = 0)) +
  theme(axis.text.y = element_text(size = 14)) +
  geom_boxplot() +
  geom_signif(comparisons = list(c("Healthy Dog","Healthy Human"),c("IBD Dog","Crohn's Disease Human"), c("IBD Dog", "Ulcerative Colitis Human")),
              y_position = c(4, 3.5, 4),
              textsize = 6,
              annotations = c("****","*","****")) +
  ylab("Shannon Diversity") +
  xlab("Species and Disease State") +
  theme(axis.title.x = element_text(size = 16, face = "bold")) +
  theme(axis.title.y = element_text(size = 16, face = "bold"))

alpha_shannon <- alpha_shannon + guides(fill=guide_legend(title="Species and Disease State"))

# Save plot
ggsave(filename = "alpha_shannon_new.png"
       , alpha_shannon
       , height=8, width=8)

##############################################################################
#### Alpha diversity - Observered ######
# Running 2 way anova
observed_species_disease <- lm(Observed ~ `V38`, data=samp_dat_wdiv)
summary(aov(observed_species_disease))
TukeyHSD(aov(observed_species_disease))

# Creating the initial box plot #
alpha_observed <- samp_dat_wdiv %>%
  mutate(V38 = fct_relevel(V38, 
                           "Healthy Dog", "Healthy Human", "IBD Dog", 
                           "Crohn's Disease Human", "Ulcerative Colitis Human")) %>%
  ggplot(aes(x=`V38`, y=Observed, fill = V38)) +
  theme_bw() +
  theme(axis.text.x = element_text(size = 14, angle = -30, hjust = 0)) +
  theme(axis.text.y = element_text(size = 14)) +
  geom_boxplot() +
  geom_signif(comparisons = list(c("Healthy Dog","Healthy Human"),c("IBD Dog","Crohn's Disease Human"), c("IBD Dog", "Ulcerative Colitis Human")),
              y_position = c(150, 180, 200),
              textsize = 6,
              annotations = c("****","****","****")) +
  ylab("Richness") +
  xlab("Species and Disease State") +
  theme(axis.title.x = element_text(size = 16, face = "bold")) +
  theme(axis.title.y = element_text(size = 16, face = "bold"))

alpha_observed <- alpha_observed + guides(fill=guide_legend(title="Species and Disease State"))

alpha_observed

# Save plot
ggsave(filename = "alpha_observed_new.png"
       , alpha_observed
       , height=8, width=8)

##############################################################################
#### Alpha diversity - Faith's PD #####

# Calculate Faith's phylogenetic diversity as PD
phylo_dist <- pd(t(otu_table(ibd_rare)), phy_tree(ibd_rare),
                 include.root=F) 

# Add PD to metadata table
samp_dat_wfaith <- data.frame(samp_dat, phylo_dist)

# Running 2 way anova
faith_species_disease <- lm(PD ~ `V38`, data=samp_dat_wfaith)
summary(aov(faith_species_disease))
TukeyHSD(aov(faith_species_disease))

# Plot any metadata category against the PD
plot.pd <- samp_dat_wfaith %>%
  mutate(V38 = fct_relevel(`V38`, 
                           "Healthy Dog", "Healthy Human", "IBD Dog", 
                           "Crohn's Disease Human", "Ulcerative Colitis Human")) %>%
  ggplot(aes(x=`V38`, y=`PD`, fill = `V38`)) +
  theme_bw() +
  theme(axis.text.x = element_text(size = 14, angle = -30, hjust = 0)) +
  theme(axis.text.y = element_text(size = 14)) +
  geom_boxplot() +
  geom_signif(comparisons = list(c("Healthy Dog","Healthy Human"),c("IBD Dog","Crohn's Disease Human"), c("IBD Dog", "Ulcerative Colitis Human")),
              y_position = c(15, 17, 19),
              textsize = 6,
              annotations = c("****","****","****")) +
  ylab("Faith's Phylogenetic Distance") +
  xlab("Species and Disease State") +
  theme(axis.title.x = element_text(size = 16, face = "bold")) +
  theme(axis.title.y = element_text(size = 16, face = "bold"))

plot.pd <- plot.pd + guides(fill=guide_legend(title="Species and Disease State"))

plot.pd

# Save plot
ggsave(filename = "alpha_faith_new.png"
       , plot.pd
       , height=8, width=8)

##############################################################################
#### Alpha diversity - Simpson ######
# Running 2 way anova
simpson_species_disease <- lm(Simpson ~ `V38`, data=samp_dat_wdiv)
summary(aov(simpson_species_disease))
TukeyHSD(aov(simpson_species_disease))

# Creating the initial box plot #
alpha_simpson <- samp_dat_wdiv %>%
  mutate(V38 = fct_relevel(V38, 
                           "Healthy Dog", "Healthy Human", "IBD Dog", 
                           "Crohn's Disease Human", "Ulcerative Colitis Human")) %>%
  ggplot(aes(x=`V38`, y=Simpson, fill = V38)) +
  theme_bw() +
  theme(axis.text.x = element_text(size = 14, angle = -30, hjust = 0)) +
  theme(axis.text.y = element_text(size = 14)) +
  geom_boxplot() +
  geom_signif(comparisons = list(c("Healthy Dog","Healthy Human"),c("IBD Dog","Crohn's Disease Human"), c("IBD Dog", "Ulcerative Colitis Human")),
              y_position = c(1, 1.1, 1.2),
              textsize = 6,
              annotations = c("n.s","n.s","****")) +
  ylab("Simpson Index") +
  xlab("Species and Disease State") +
  theme(axis.title.x = element_text(size = 16, face = "bold")) +
  theme(axis.title.y = element_text(size = 16, face = "bold"))

alpha_simpson <- alpha_simpson + guides(fill=guide_legend(title="Species and Disease State"))

alpha_simpson

# Save plot
ggsave(filename = "alpha_simpson_new.png"
       , alpha_simpson
       , height=8, width=8)


##############################################################################
#### Alpha diversity - Chao ######
# Running 2 way anova
chao_species_disease <- lm(Chao1 ~ `V38`, data=samp_dat_wdiv)
summary(aov(chao_species_disease))
TukeyHSD(aov(chao_species_disease))

# Creating the initial box plot #
alpha_chao <- samp_dat_wdiv %>%
  mutate(V38 = fct_relevel(V38, 
                           "Healthy Dog", "Healthy Human", "IBD Dog", 
                           "Crohn's Disease Human", "Ulcerative Colitis Human")) %>%
  ggplot(aes(x=`V38`, y=Chao1, fill = V38)) +
  theme_bw() +
  theme(axis.text.x = element_text(size = 14, angle = -30, hjust = 0)) +
  theme(axis.text.y = element_text(size = 14)) +
  geom_boxplot() +
  geom_signif(comparisons = list(c("Healthy Dog","Healthy Human"),c("IBD Dog","Crohn's Disease Human"), c("IBD Dog", "Ulcerative Colitis Human")),
              y_position = c(145, 155, 165),
              textsize = 6,
              annotations = c("****","****","****")) +
  ylab("Chao Index") +
  xlab("Species and Disease State") +
  theme(axis.title.x = element_text(size = 16, face = "bold")) +
  theme(axis.title.y = element_text(size = 16, face = "bold"))

alpha_chao <- alpha_chao + guides(fill=guide_legend(title="Species and Disease State"))

alpha_chao


# Save plot
ggsave(filename = "alpha_chao_new.png"
       , alpha_chao
       , height=8, width=8)